# ShogiDRL / Keisei Code Map
# As Of: 2025-05-28
# ==========================

| #     | Sub-system                         | Sub-sections & purpose                                                                                                                                                                                                                                           | Core / supporting files                                                                                                                           | **Reviewer watch-list (issues & risks)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| ----- | ---------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **1** | **Configuration & Overrides**      | Pydantic schema; YAML/JSON/CLI/env loaders.<br>• *Consumers*: training/evaluation CLIs.                                                                                                                                                                          | `config_schema.py` · `utils/utils.py` (`load_config`, `FLAT_KEY_TO_NESTED`, `generate_run_name`) · `training/train.py` · `evaluation/evaluate.py` | • **num\_actions\_total vs PolicyOutputMapper** – must be validated not duplicated.<br>• Device-string validator absent (e.g. `"cuda:O"` typo).<br>• Unknown CLI/env keys silently dropped ⇒ add warnings.<br>• Keep defaults in `default_config.yaml` & schema aligned.<br>• `load_config` merge logic getting gnarly – refactor if it grows.                                                                                                                                                                                                                                                                                                                                   |
| **2** | **Shogi Engine Core**              | **2a Definitions/constants** (`shogi_core_definitions.py`)<br>**2b Rules/move-gen** (`shogi_rules_logic.py`)<br>**2c Move exec/undo** (`shogi_move_execution.py`, parts of `shogi_game.py`)<br>**2d I/O & feature builders** (`shogi_game_io.py`, `features.py`) | see left                                                                                                                                          | • Perf: lists + `copy.deepcopy` in hotspots – profile.<br>• Replace `DEBUG_*` prints with `logging`.<br>• Stress-test **uchi-fu-zume**, **sennichite**, mandatory promotion.<br>• Repetition hash includes “player who just moved” – check vs official rule wording.<br>• Unit-test via SFEN fixtures; coverage currently thin.<br>• Single source-of-truth for observation plane indices.<br>• **NEW KIF formatting** – move strings in `game_to_kif` non-standard.<br>• **NEW Redundant feature builder** – `build_core46` duplicates logic in `generate_neural_network_observation`.<br>• **NEW SFEN helpers scattered** – consider consolidating parsing/encoding utilities. |
| **3** | **Policy ↔ Move Mapping**          | Action-index ⇆ `MoveTuple` ⇆ USI & pretty text.                                                                                                                                                                                                                  | `utils/utils.py` (`PolicyOutputMapper`) · `utils/move_formatting.py`                                                                              | • 13 527 action space hard-coded – derive/validate against config.<br>• Fallback enum-value matching brittle – normalise MoveTuples.<br>• Version/tag the mapping for checkpoint compatibility.<br>• Masking: -inf logits & potential NaN softmax – keep tests.<br>• **NEW Mapper used by training/eval must match EnvConfig – enforce at start-up.**                                                                                                                                                                                                                                                                                                                            |
| **4** | **Neural-Net Models**              | Torch architectures & factory.                                                                                                                                                                                                                                   | `core/neural_network.py` · `training/models/resnet_tower.py` · `training/models/__init__.py`                                                      | • **CRITICAL Model mismatch (NEW)** – `Trainer` builds ResNet tower but `PPOAgent` uses simple `ActorCritic`; reconcile or delete dead path.<br>• `load_checkpoint_with_padding` only patches first conv – generalise for multi-stem nets.<br>• BatchNorm stats portability CPU ↔ GPU.<br>• Gradient clipping norm only; decide if value clip needed.<br>• Factory “dummy” fallback – raise/warn in prod runs.                                                                                                                                                                                                                                                                   |
| **5** | **Reinforcement-Learning Core**    | **5a PPO agent** (`core/ppo_agent.py`)<br>**5b Experience buffer** (`core/experience_buffer.py`)                                                                                                                                                                 | see left                                                                                                                                          | • Buffer stacks tensors each epoch – look at pre-allocation for speed.<br>• **NEW Memory footprint** – storing full `legal_mask` per step is big (13 k × steps).<br>• `gradient_clip_max_norm` default 0 .5 – confirm scaling.<br>• Agent `learn()` prints warnings but no broad `except` – that’s good; keep it explicit.                                                                                                                                                                                                                                                                                                                                                       |
| **6** | **Training Orchestration & UI**    | **6a Main loop** (`training/trainer.py`, `training/train.py`)<br>**6b Callbacks** (`training/callbacks.py` – needs `import os`, **NEW**)<br>**6c Rich display** (`training/display.py`)                                                                          | `training/utils.py` (dir setup, seeding, WandB)                                                                                                   | • **CRITICAL Incomplete resume (NEW)** – model weights load but timestep/episode counters & win stats not restored.<br>• Broad `except` blocks in training step hide bugs – tighten.<br>• Mixed-precision scaler created even on CPU – guard.<br>• Per-line log flush = NFS killer; buffer.<br>• Callbacks (esp. evaluation) run inside TUI loop – ensure they don’t block.<br>• Redundant `self.model` attr (see subsystem 4 mismatch).                                                                                                                                                                                                                                         |
| **7** | **Evaluation Pipeline**            | Evaluator, opponents, CLI.                                                                                                                                                                                                                                       | `evaluation/evaluate.py` · `evaluate.py` · `training/callbacks.py`                                                                                | • Ensure correct `input_channels` when loading checkpoints (was hard-coded fallback).<br>• Duplicate W\&B init error handling – unify style.<br>• `SimpleHeuristicOpponent` brittle indices – add tests.<br>• Dummy `/tmp/` logging paths – clarify vs real log dir.<br>• Fail fast if opponent load returns `None`.                                                                                                                                                                                                                                                                                                                                                             |
| **8** | **Logging, Checkpointing & WandB** | Plain/Rich loggers, save/load, checkpoint migration.                                                                                                                                                                                                             | `utils/utils.py` (loggers) · `utils/checkpoint.py`                                                                                                | • Switch `print(..., file=sys.stderr)` to `logging` consistently.<br>• Buffered writes for heavy logging runs.<br>• `load_checkpoint_with_padding` only covers `stem.weight` – add pattern matching for multiple stems (**NEW**).<br>• Handle `PermissionError` on `os.makedirs`.                                                                                                                                                                                                                                                                                                                                                                                                |
| **9** | **Entry-points & Re-exports**      | Import-graph roots & thin wrappers.                                                                                                                                                                                                                              | Package-level `__init__.py` files · root `evaluate.py`                                                                                            | • Run static cycle checker (`pycycle`, pylint cyclic-import) to ensure no new loops.<br>• Keep `__init__.py` side-effects minimal.<br>• Maintain `__all__` lists to help tools/intellisense.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |

**Legend:** **NEW** = bullet newly added compared with the previous map.
